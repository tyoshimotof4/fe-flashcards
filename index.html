<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FE / SG / iパス 2択フラッシュカード</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    #app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: #ffffff;
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      text-align: center;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 8px;
    }
    h2 {
      font-size: 18px;
      margin: 0 0 12px;
    }
    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      font-size: 17px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-sizing: border-box;
    }
    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-secondary {
      background: #eeeeee;
      color: #333;
    }
    .btn-tertiary {
      background: #66bb6a;
      color: #333;
    }
    .btn-randomtitl {
      background: #ffb74d;
      color: #333;
    }
    .btn-a {
      background: #43a047;
      color: #fff;
    }
    .btn-b {
      background: #e53935;
      color: #fff;
    }
    .btn-next {
      background: #4fc3f7;/*#0288d1*/
      color: #000;
    }
    .btn-small {
      padding: 10px;
      font-size: 14px;
      width: auto;
      display: inline-block;
    }
    /* ★ リセットボタン：黄色＋黒文字に変更 */
    .btn-danger {
      background: #ffeb3b;
      color: #000;
    }
    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #1565c0;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .question-text {
      font-size: 18px;
      margin: 10px 0 12px;
      line-height: 1.5;
      text-align: left;
    }
    .result {
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
      min-height: 1.5em;
    }
    .explanation {
      font-size: 13px;
      color: #555;
      margin-top: 6px;
      text-align: left;
    }
    .hidden {
      display: none;
    }
    .genre-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .genre-btn {
      padding: 10px;
      font-size: 14px;
      border-radius: 999px;
      border: none;
      background: #eeeeee;
      cursor: pointer;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 13px;
      color: #555;
    }
    .score {
      font-size: 13px;
      color: #444;
      margin-bottom: 6px;
      text-align: right;
      min-height: 1.2em;
    }
    .totalscore {
      font-size: 12px;
      color: #777;
      margin-bottom: 8px;
      text-align: right;
      min-height: 1.2em;
    }
    .exam-name {
      font-weight: bold;
      color: #1565c0;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- ★ 試験選択画面 ★ -->
    <div id="screen-exam" class="card">
      <h1>試験区分を選択</h1>
      <p class="subtitle">学習したい試験を選んでください</p>
      <button class="btn btn-primary" onclick="selectExam('fe')">
        基本情報技術者試験
      </button>
      <button class="btn btn-secondary" onclick="selectExam('sg')">
        情報セキュリティマネジメント試験
      </button>
      <!-- ★ 追加した iパスボタン -->
      <button class="btn btn-tertiary" onclick="selectExam('ip')">
        ITパスポート試験
      </button>
      <p class="subtitle" style="margin-top:16px;">
        ・同じ画面デザインで3つの試験を学習できます。<br>
        ・通算成績は試験ごとに別々に記録されます。
      </p>
    </div>

    <!-- モード選択メニュー -->
    <div id="screen-menu" class="card hidden">
      <h1 id="appTitle">2択フラッシュカード</h1>
      <p class="subtitle">
        <span class="exam-name" id="examLabel"></span> ／
        片手タップでサクサク解ける学習アプリ
      </p>
      <button class="btn btn-randomtitl" onclick="selectMode('random')">
        ランダム出題（全ジャンル）
      </button>
      <button class="btn btn-secondary" onclick="selectMode('genre')">
        ジャンル別に解く
      </button>
      <p id="loadStatus" class="subtitle"></p>
      <button class="btn btn-small" onclick="backToExam()">← 試験選択に戻る</button>
    </div>

    <!-- ジャンル選択画面 -->
    <div id="screen-genre" class="card hidden">
      <h2>ジャンルを選択</h2>
      <p class="subtitle">
        <span class="exam-name" id="examLabelGenre"></span> ／
        解きたい分野をタップしてください
      </p>
      <div id="genreButtons" class="genre-grid"></div>
      <button class="btn btn-small" onclick="backToMenu()">← メニューへ戻る</button>
    </div>

    <!-- クイズ画面 -->
    <div id="screen-quiz" class="card hidden">
      <div class="topbar">
        <span id="quizModeLabel"></span>
        <span id="progress"></span>
      </div>
      <div class="totalscore" id="totalScore"></div>
      <div id="score" class="score"></div>
      <div class="tag" id="genreTag"></div>
      <p class="question-text" id="question"></p>
      <button class="btn btn-a" onclick="answer('A')">A：正しい</button>
      <button class="btn btn-b" onclick="answer('B')">B：誤り</button>
      <div id="result" class="result"></div>
      <div id="explanation" class="explanation"></div>
      <button id="nextBtn" class="btn btn-next hidden" onclick="nextQuestion()">次の問題へ ＝≫</button>

      <div style="margin-top:12px;">
        <button class="btn btn-small" onclick="backToMenu()">← メニュー</button>
        <button class="btn btn-small btn-danger" onclick="resetCumulativeScore()">
          通算成績をリセット
        </button>
      </div>
    </div>
  </div>

  <script>
    // --- 試験区分ごとの情報 ---
    const examInfo = {
      fe: {
        name: '基本情報技術者試験',
        file: 'fe_questions.json',   // 基本情報の問題ファイル名
        storageKey: 'fe_flash_stats_fe'
      },
      sg: {
        name: '情報セキュリティマネジメント試験',
        file: 'sg_questions.json',   // セキュリティマネジメントの問題ファイル名
        storageKey: 'fe_flash_stats_sg'
      },
      // ★ ITパスポートを追加
      ip: {
        name: 'ITパスポート試験',
        file: 'ip_questions.json',   // ITパスポートの問題ファイル名
        storageKey: 'fe_flash_stats_ip'
      }
    };

    let currentExam = null;       // 'fe' or 'sg' or 'ip'
    let questions = [];
    let questionsLoaded = false;

    // 出題モードと状態
    let mode = null;              // 'random' or 'genre'
    let currentGenre = null;
    let order = [];               // 出題順インデックス配列
    let index = 0;
    let answeredCurrent = false;  // この問題で既に回答したか

    // セッション成績
    let sessionCorrect = 0;
    let sessionAnswer  = 0;

    // 通算成績（試験ごと）
    let totalCorrect = 0;
    let totalAnswer  = 0;

    // --- DOM 取得 ---
    const screenExam   = document.getElementById('screen-exam');
    const screenMenu   = document.getElementById('screen-menu');
    const screenGenre  = document.getElementById('screen-genre');
    const screenQuiz   = document.getElementById('screen-quiz');

    const appTitle     = document.getElementById('appTitle');
    const examLabel    = document.getElementById('examLabel');
    const examLabelGenre = document.getElementById('examLabelGenre');

    const loadStatusEl = document.getElementById('loadStatus');
    const genreButtons = document.getElementById('genreButtons');
    const genreTag     = document.getElementById('genreTag');
    const questionEl   = document.getElementById('question');
    const resultEl     = document.getElementById('result');
    const explanationEl = document.getElementById('explanation');
    const nextBtn      = document.getElementById('nextBtn');
    const quizModeLabel= document.getElementById('quizModeLabel');
    const progressEl   = document.getElementById('progress');
    const scoreEl      = document.getElementById('score');
    const totalScoreEl = document.getElementById('totalScore');

    // 画面切り替え
    function showScreen(target) {
      screenExam.classList.add('hidden');
      screenMenu.classList.add('hidden');
      screenGenre.classList.add('hidden');
      screenQuiz.classList.add('hidden');
      if (target === 'exam')  screenExam.classList.remove('hidden');
      if (target === 'menu')  screenMenu.classList.remove('hidden');
      if (target === 'genre') screenGenre.classList.remove('hidden');
      if (target === 'quiz')  screenQuiz.classList.remove('hidden');
    }

    // --- 試験選択 ---
    function selectExam(examKey) {
      const info = examInfo[examKey];
      if (!info) {
        alert('未対応の試験区分です。');
        return;
      }
      currentExam = examKey;
      questions = [];
      questionsLoaded = false;
      loadStatusEl.textContent = '問題を読み込み中…';

      // タイトルなど更新
      appTitle.textContent = info.name + ' 2択フラッシュカード';
      examLabel.textContent = info.name;
      examLabelGenre.textContent = info.name;

      // セッション成績リセット
      resetSessionScore();

      // 通算成績読み込み
      loadCumulativeScore();

      // 問題ファイルを読み込む
      fetch(info.file)
        .then(res => res.json())
        .then(data => {
          questions = data;
          questionsLoaded = true;
          loadStatusEl.textContent = '問題数：' + questions.length + '問 読み込み済み';
          showScreen('menu');
        })
        .catch(err => {
          console.error(err);
          questionsLoaded = false;
          loadStatusEl.textContent =
            '※ ' + info.file + ' が読み込めませんでした。\n' +
            'HTMLファイルと同じフォルダに配置し、簡易Webサーバー経由で開いてください。';
          alert('問題データが読み込めませんでした。ファイル名と配置を確認してください。');
          showScreen('exam');
        });
    }

    function backToExam() {
      currentExam = null;
      questions = [];
      questionsLoaded = false;
      loadStatusEl.textContent = '';
      showScreen('exam');
    }

    // --- 成績管理 ---
    function resetSessionScore() {
      sessionCorrect = 0;
      sessionAnswer  = 0;
      updateScoreDisplays();
    }

    function loadCumulativeScore() {
      if (!currentExam) return;
      const key = examInfo[currentExam].storageKey;
      const saved = localStorage.getItem(key);
      if (saved) {
        try {
          const obj = JSON.parse(saved);
          totalCorrect = obj.totalCorrect || 0;
          totalAnswer  = obj.totalAnswer || 0;
        } catch (e) {
          totalCorrect = 0;
          totalAnswer  = 0;
        }
      } else {
        totalCorrect = 0;
        totalAnswer  = 0;
      }
      updateScoreDisplays();
    }

    function saveCumulativeScore() {
      if (!currentExam) return;
      const key = examInfo[currentExam].storageKey;
      const obj = {
        totalCorrect,
        totalAnswer
      };
      localStorage.setItem(key, JSON.stringify(obj));
    }

    function resetCumulativeScore() {
      if (!currentExam) {
        alert('試験区分が選択されていません。');
        return;
      }
      const info = examInfo[currentExam];
      if (!confirm(info.name + ' の通算成績をリセットします。よろしいですか？')) {
        return;
      }
      totalCorrect = 0;
      totalAnswer  = 0;
      saveCumulativeScore();
      updateScoreDisplays();
      alert('通算成績をリセットしました。');
    }

    function updateScoreDisplays() {
      // 通算成績
      if (totalAnswer === 0) {
        totalScoreEl.textContent = '【通算】まだ解答履歴はありません。';
      } else {
        const rate = Math.round((totalCorrect / totalAnswer) * 100);
        totalScoreEl.textContent =
          '【通算】正解 ' + totalCorrect + ' / ' + totalAnswer +
          '（正答率 ' + rate + '%）';
      }

      // セッション成績
      if (sessionAnswer === 0) {
        scoreEl.textContent = '';
      } else {
        const rate = Math.round((sessionCorrect / sessionAnswer) * 100);
        scoreEl.textContent =
          '【今回】正解 ' + sessionCorrect + ' / ' + sessionAnswer +
          '（正答率 ' + rate + '%）';
      }
    }

    // --- モード選択 ---
    function ensureLoaded() {
      if (!currentExam) {
        alert('まず試験区分を選択してください。');
        showScreen('exam');
        return false;
      }
      if (!questionsLoaded || questions.length === 0) {
        alert('問題データがまだ読み込まれていません。\n数秒後にもう一度お試しください。');
        return false;
      }
      return true;
    }

    function selectMode(m) {
      if (!ensureLoaded()) return;
      mode = m;
      resetSessionScore();
      if (mode === 'random') {
        startRandomMode();
      } else if (mode === 'genre') {
        buildGenreButtons();
        showScreen('genre');
      }
    }

    function backToMenu() {
      mode = null;
      currentGenre = null;
      resetSessionScore();
      showScreen('menu');
    }

    // --- ジャンル選択 ---
    function buildGenreButtons() {
      genreButtons.innerHTML = '';
      const genreSet = new Set(questions.map(q => q.g));
      const genres = Array.from(genreSet);
      genres.forEach(g => {
        const btn = document.createElement('button');
        btn.textContent = g;
        btn.className = 'genre-btn';
        btn.onclick = () => startGenreMode(g);
        genreButtons.appendChild(btn);
      });
    }

    // --- 出題 ---
    function startRandomMode() {
      quizModeLabel.textContent = 'モード：ランダム';
      currentGenre = null;
      order = [...Array(questions.length).keys()];
      shuffle(order);
      index = 0;
      loadQuestion();
      showScreen('quiz');
    }

    function startGenreMode(genre) {
      quizModeLabel.textContent = 'モード：ジャンル別';
      currentGenre = genre;
      order = questions
        .map((q, i) => ({ q, i }))
        .filter(obj => obj.q.g === genre)
        .map(obj => obj.i);
      if (order.length === 0) {
        alert('このジャンルの問題が見つかりませんでした。');
        return;
      }
      shuffle(order);
      index = 0;
      loadQuestion();
      showScreen('quiz');
    }

    function loadQuestion() {
      const qIndex = order[index];
      const q = questions[qIndex];
      genreTag.textContent = q.g;
      questionEl.textContent = q.q;
      resultEl.textContent = '';
      explanationEl.textContent = '';
      nextBtn.classList.add('hidden');
      answeredCurrent = false;
      progressEl.textContent = (index + 1) + ' / ' + order.length;
      updateScoreDisplays();
    }

    function answer(choice) {
      if (answeredCurrent) {
        // 同じ問題で2回以上はカウントしない
        return;
      }
      answeredCurrent = true;

      const qIndex = order[index];
      const q = questions[qIndex];

      // セッション・通算ともにカウント
      sessionAnswer++;
      totalAnswer++;
      if (choice === q.a) {
        sessionCorrect++;
        totalCorrect++;
        resultEl.textContent = '◎ 正解！';
        resultEl.style.color = '#43a047';
      } else {
        resultEl.textContent = '× 不正解';
        resultEl.style.color = '#e53935';
      }

      if (q.e) {
        explanationEl.textContent = '【解説】' + q.e;
      } else {
        explanationEl.textContent = '';
      }

      saveCumulativeScore();
      updateScoreDisplays();
      nextBtn.classList.remove('hidden');
    }

    function nextQuestion() {
      index = (index + 1) % order.length;
      loadQuestion();
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // 初期表示
    showScreen('exam');
  </script>
</body>
</html>
